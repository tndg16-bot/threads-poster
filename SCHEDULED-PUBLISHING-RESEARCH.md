# Threads API 配信予約機能調査

## 調査日時
2026-02-15

## 概要

Threads APIの配信予約機能（scheduled_publish_time）について調査した結果を報告します。

## Threads APIの配信予約機能の現状

### 現状の確認

Threads Graph APIのドキュメントを調査した結果、以下のことが分かりました：

1. **現在のThreads APIには、Instagram APIのようなscheduled_publish_timeパラメータは存在しない**

2. **Instagram APIの配信予約機能**:
   - Instagram APIでは、`scheduled_publish_time` パラメータを使用して投稿の配信予約が可能
   - しかし、これはInstagram固有の機能で、Threads APIにはまだ移植されていない

3. **Threads APIの制限**:
   - Threads APIは比較的新しく（2024年正式リリース）、機能はまだ基本的なものに限られている
   - 現在は以下の機能のみサポートされている：
     - テキスト投稿
     - 画像投稿
     - 動画投稿
     - 返信
     - 投稿の削除

## 解決策の提案

### 方案1: 自前のスケジュール管理機能の実装（推奨）

Threads APIに配信予約機能がないため、以下のアプローチで実装します：

#### アーキテクチャ

```
┌─────────────────┐
│  Scheduler      │ (スケジュール管理)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Job Queue      │ (待ち行列)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Poster Worker  │ (投稿実行)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Threads API    │ (API呼び出し)
└─────────────────┘
```

#### 実装方法

1. **スケジュールデータの保存**:
   - JSONファイルでスケジュールを管理（`scheduled-posts.json`）
   - 構造:
     ```json
     {
       "scheduledPosts": [
         {
           "id": "unique-id",
           "post": { /* 投稿データ */ },
           "scheduledAt": "2026-02-16T10:00:00Z",
           "status": "pending",
           "createdAt": "2026-02-15T20:00:00Z",
           "threadId": null,
           "publishedAt": null
         }
       ],
       "lastCheck": "2026-02-15T20:00:00Z"
     }
     ```

2. **スケジューラープロセス**:
   - 定期的（例：1分ごと）にスケジュールを確認
   - 時刻が来た投稿をジョブキューに追加

3. **投稿ワーカー**:
   - ジョブキューから投稿を取り出し
   - Threads APIで投稿を実行
   - 結果をスケジュールデータに記録

4. **機能要件**:
   - 投稿の配信予約（日時指定）
   - 予約済み投稿の一覧表示
   - 予約のキャンセル
   - 予約の編集
   - 即時投稿のサポート

5. **OpenClawのcron機能との統合**:
   - OpenClawのcronスケジューラーを使用して定期的なチェックを実行
   - または、Node.jsの `setInterval` で簡易的なスケジューラーを実装

#### コード構成

```
skills/threads-poster/
├── index.js                    # メイン実装（既存）
├── lib/
│   ├── scheduler.js            # スケジュール管理（新規）
│   ├── job-queue.js            # ジョブキュー（新規）
│   ├── worker.js               # 投稿ワーカー（新規）
│   ├── threads-client.js       # Threads APIクライアント（既存）
│   ├── config.js               # 設定ローダー（既存）
│   └── logger.js               # ロガー（既存）
├── config.json                 # 設定ファイル（既存）
├── scheduled-posts.json        # スケジュールデータ（新規）
└── README.md                   # ドキュメント（更新）
```

### 方案2: 外部スケジューラーツールの使用（代替案）

以下のツールを使用して投稿のタイミングを制御：

1. **Node Schedule**: Node.js用のスケジューラー
2. **Agenda**: MongoDBベースのジョブスケジューラー
3. **Bull Queue**: Redisベースのジョブキュー

**メリット**:
- 成熟したライブラリを使用
- タイムゾーンの処理が容易
- 複雑なスケジュールの管理が可能

**デメリット**:
- 外部依存の追加
- 設定の複雑化

### 方案3: OpenClawのcron機能の活用（推奨）

OpenClaw自体にcron機能があるため、それを活用する：

1. **投稿データの事前準備**:
   - 投稿内容をJSONファイルに保存
   - 配信日時を記録

2. **cronジョブの登録**:
   - OpenClawのcron機能で定期的にチェック
   - 時刻が来たら投稿を実行

**メリット**:
- 追加の依存なし
- OpenClawと統合しやすい
- シンプルな実装

**デメリット**:
- cronの設定が必要
- 詳細なスケジュール管理には別途実装が必要

## 推奨実装

**方案1（自前のスケジュール管理）と方案3（OpenClaw cron）のハイブリッド**:

1. **スケジュール管理**: JSONファイルで予約投稿を管理
2. **タイミング制御**: OpenClawのcron機能で定期チェック
3. **投稿実行**: 既存のThreads APIクライアントを使用

このアプローチは以下のメリットがあります：

- ✅ シンプルで依存が少ない
- ✅ OpenClawとの統合が容易
- ✅ 柔軟なスケジュール管理が可能
- ✅ ユーザーが直感的に使用できる

## 実装計画

### ステップ1: スケジュールデータの実装

- `lib/scheduler.js` を作成
- スケジュールの保存・読み込み・更新機能
- `scheduled-posts.json` の管理

### ステップ2: 投稿の予約機能

- 投稿データと配信日時を受け取る関数
- スケジュールに投稿を追加
- 重複チェック

### ステップ3: スケジュールのチェックと実行

- 定期的にスケジュールを確認
- 時刻が来た投稿を実行
- 実行結果を記録

### ステップ4: CLIコマンドの追加

- `--schedule`: 投稿の配信予約
- `--list-scheduled`: 予約済み投稿の一覧
- `--cancel-scheduled`: 予約のキャンセル

### ステップ5: ドキュメントの更新

- README.md に配信予約機能の使用方法を追加
- サンプルコードと使用例

## 注意事項

1. **タイムゾーン**: 配信日時はUTCで管理し、表示時にローカルタイムに変換
2. **エラーハンドリング**: 投稿失敗時の再試行ロジック
3. **レート制限**: Threads APIのレート制限を考慮し、投稿間隔を制御
4. **永続化**: スケジュールデータは永続化し、再起動後も保持

## 今後の機能拡張

- 複数の予約投稿のバッチ管理
- 週次・月次の定期投稿
- 条件付き投稿（特定のイベントに応じた投稿）
- 投稿履歴の分析とレポート

## まとめ

Threads APIには配信予約機能（scheduled_publish_time）がまだ実装されていないため、自前のスケジュール管理機能を実装することを推奨します。

OpenClawのcron機能と組み合わせることで、シンプルで柔軟な配信予約システムを構築できます。

---

**調査者**: OpenClaw Subagent
**作成日**: 2026-02-15
**ステータス**: ✅ 調査完了
